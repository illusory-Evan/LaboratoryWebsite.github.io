<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>駕駛信用評分系統 - ES912</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --light-gray: #f8f9fa;
      --medium-gray: #dee2e6;
      --dark-gray: #343a40;
      --border-color: #ced4da;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --danger-color: #dc3545;
      --success-color: #28a745;
      --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --border-radius: 0.3rem;
      --transition-speed: 0.2s;
    }
    body { background: var(--light-gray); margin: 0; font-family: var(--font-family); }
    .container { max-width: 960px; margin: 20px auto; background: #fff; padding: 20px; border-radius: var(--border-radius); box-shadow: 0 2px 10px var(--shadow-color); }
    .site-header { margin-bottom: 20px; }
    .header-img { width: 100%; height: auto; display: block; border-radius: var(--border-radius); }

    /* Top Section */
    .top-section { display: grid; grid-template-columns: repeat(3,1fr); gap: 20px; margin-bottom: 30px; }
    .card { background: var(--light-gray); border-radius: var(--border-radius); padding: 16px; text-align: center; }
    .card img { width: 100%; height: auto; border-radius: var(--border-radius); }
    .card h3 { margin: 0 0 12px; font-size: 1.1em; }
    .score-card { display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .score-card .score-label { font-size: 1.3em; margin-bottom: 12px; }
    .score-card #Point { font-size: 3em; color: var(--danger-color); }

    /* Info Grid */
    .info-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 20px; margin-bottom: 30px; }
    .info-card { background: var(--light-gray); border-radius: var(--border-radius); padding: 12px; text-align: center; }
    .info-card strong { display: block; margin-bottom: 8px; }

    /* Bottom Section */
    .bottom-section { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

    /* 記錄日誌藍色樣式 */
    .log-card { background: #fff; border-radius: var(--border-radius); box-shadow: 0 1px 3px var(--shadow-color); }
    .log-card h3 { background: var(--primary-color); color: #fff; margin: 0; padding: 12px; font-size: 1.2em; border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); text-align: center; }
    .scrollable-list { max-height: 240px; overflow-y: auto; list-style: none; margin: 0; padding: 0; text-align: center; }
    .scrollable-list li { background: var(--light-gray); margin: 4px 0; padding: 10px; padding-left: 35%; border-radius: var(--border-radius); text-align: left; }

    .summary-wrapper { display: flex; flex-direction: column; gap: 20px; }
    .summary-card { background: var(--light-gray); border-radius: var(--border-radius); overflow: hidden; box-shadow: 0 1px 3px var(--shadow-color); }
    .summary-card h3 { background: var(--secondary-color); color: #fff; margin: 0; padding: 10px; font-size: 1.1em; text-align: center; }
    .summary-card table { width: 100%; border-collapse: collapse; }
    .summary-card td { padding: 10px; text-align: center; }

    .loading { opacity: 0.5; pointer-events: none; }
    .loading-indicator { text-align: center; margin: 10px 0; color: var(--secondary-color); }
  </style>
</head>
<body>
  <div class="container">
    <header class="site-header">
      <img src="images/0.jpg" alt="駕駛信用評分系統" class="header-img">
    </header>
    <div id="loading-text" class="loading-indicator">資料載入中...</div>
    <section class="top-section">
      <div class="card image-card"><h3>汽車圖片</h3><img id="CarImg" src="images/car.jpg" alt="汽車圖片"></div>
      <div class="card image-card"><h3>駕駛人圖片</h3><img id="DriverImg" src="images/person.jpg" alt="駕駛人圖片"></div>
      <div class="card score-card"><div class="score-label">總評分</div><div id="Point">--</div></div>
    </section>
    <section class="info-grid">
      <div class="info-card"><strong>汽車款式型號</strong><span id="CarBrand">---</span></div>
      <div class="info-card"><strong>汽車車牌號</strong><span id="LicensePlate">---</span></div>
      <div class="info-card"><strong>駕駛人身分證</strong><span id="DriverID">---</span></div>
      <div class="info-card"><strong>駕駛人生日</strong><span id="DriverBirthday">---</span></div>
    </section>
    <section class="bottom-section">
      <div class="log-card">
        <h3>記錄日誌</h3>
        <ul class="scrollable-list">
          <li id="log1"></li>
          <li id="log2"></li>
          <li id="log3"></li>
          <li id="log4"></li>
          <li id="log5"></li>
        </ul>
      </div>
      <div class="summary-wrapper">
        <div class="summary-card violation-card">
          <h3>違規次數</h3>
          <table>
            <tr><td>車距過近</td><td><span id="TooClose">0</span> 次</td></tr>
            <tr><td>壓車道線</td><td><span id="LanePressingLine">0</span> 次</td></tr>
          </table>
        </div>
        <div class="summary-card state-card">
          <h3>駕駛狀態檢測</h3>
          <table>
            <tr><td>分心</td><td><span id="Distractions">0</span> 次</td></tr>
            <tr><td>打瞌睡</td><td><span id="Nod">0</span> 次</td></tr>
            <tr><td>使用手機</td><td><span id="UsingMobilePhone">0</span> 次</td></tr>
            <tr><td>抽菸</td><td><span id="Smoke">0</span> 次</td></tr>
            <tr><td>未繫安全帶</td><td><span id="SeatBelt">0</span> 次</td></tr>
          </table>
        </div>
      </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref as dbRef, onValue } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    import { getStorage, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";
    const firebaseConfig = { apiKey: "AIzaSyCK4juwHIRyHmWx5wrZXb2uxLKJoeZ0cdw", authDomain: "drivingcreditscoringsystem.firebaseapp.com", databaseURL: "https://drivingcreditscoringsystem-default-rtdb.firebaseio.com", projectId: "drivingcreditscoringsystem", storageBucket: "drivingcreditscoringsystem.firebasestorage.app", messagingSenderId: "705137872436", appId: "1:705137872436:web:97058309dc0076f7e2c461" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const refs = { CarBrand: document.getElementById("CarBrand"), LicensePlate: document.getElementById("LicensePlate"), DriverID: document.getElementById("DriverID"), DriverBirthday: document.getElementById("DriverBirthday"), Point: document.getElementById("Point"), TooClose: document.getElementById("TooClose"), LanePressingLine: document.getElementById("LanePressingLine"), Distractions: document.getElementById("Distractions"), Nod: document.getElementById("Nod"), UsingMobilePhone: document.getElementById("UsingMobilePhone"), Smoke: document.getElementById("Smoke"), CarImg: document.getElementById("CarImg"), DriverImg: document.getElementById("DriverImg"), logs: [1,2,3,4,5].map(i => document.getElementById(`log${i}`)), loadingText: document.getElementById("loading-text") };
    function updateViolation(data) {
      // 先保證有 Log 陣列，再排序：依時間由大到小（最新在前）
      const sorted = (data.Log || []).slice().sort((a, b) => {
        // 例如「2025-04-17 18:12:32 壓車道線」
        const tA = new Date(a.split(' ')[0] + ' ' + a.split(' ')[1]).getTime();
        const tB = new Date(b.split(' ')[0] + ' ' + b.split(' ')[1]).getTime();
        return tB - tA;
      });
      // 只取最新 5 筆
      const arr = sorted.slice(0, 5);
      // 填入畫面
      refs.logs.forEach((el, i) => {
        el.textContent = arr[i] || '';
      });
    }
    function setLoading(show) {
      document.querySelectorAll('.card, .info-card, .log-card, .summary-card').forEach(el => el.classList.toggle('loading', show));
      refs.loadingText.style.display = show ? 'block' : 'none';
    }
    const driverID = 'A123456789'; setLoading(true);
    onValue(dbRef(db, `/ID/${driverID}`), snap => { setLoading(false); if (!snap.exists()) return; const data = snap.val(); refs.CarBrand.textContent = data.CarBrand || '---'; refs.LicensePlate.textContent = data.LicensePlate || '---'; refs.DriverID.textContent = driverID; refs.DriverBirthday.textContent = data.DriverBirthday || '---'; refs.Point.textContent = data.Point ?? '--'; if (data.CarImgURL) getDownloadURL(storageRef(storage, data.CarImgURL)).then(url => refs.CarImg.src = url).catch(() => refs.CarImg.src = 'images/car.jpg'); if (data.DriverImgURL) getDownloadURL(storageRef(storage, data.DriverImgURL)).then(url => refs.DriverImg.src = url).catch(() => refs.DriverImg.src = 'images/person.jpg'); updateViolation(data); }, err => { setLoading(false); console.error('Firebase error:', err); });
  </script>
</body>
</html>